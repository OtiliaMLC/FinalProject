{% extends "layout.html" %}

{% block title %}Dashboard - Bootstrap Budget Tracker{% endblock %}

{% block content %}
<div class="dashboard">
    <div class="dashboard-header">
        <h2>Your Marketing Campaigns</h2>
        <a href="{{ url_for('create_campaign') }}" class="btn btn-primary">+ Create New Campaign</a>
    </div>

    {% if campaigns %}
        <!-- Filter Section -->
        <div class="filter-section">
            <form method="GET" action="{{ url_for('dashboard') }}" class="filter-form">
                <div class="filter-group">
                    <label for="filter_channel">Filter by Channel:</label>
                    <select id="filter_channel" name="channel" onchange="this.form.submit()">
                        <option value="">All Channels</option>
                        <option value="Instagram">Instagram</option>
                        <option value="Facebook">Facebook</option>
                        <option value="Google Ads">Google Ads</option>
                        <option value="TikTok">TikTok</option>
                        <option value="LinkedIn">LinkedIn</option>
                        <option value="Email Marketing">Email Marketing</option>
                        <option value="Twitter/X">Twitter/X</option>
                        <option value="YouTube">YouTube</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter_status">Filter by Status:</label>
                    <select id="filter_status" name="status" onchange="this.form.submit()">
                        <option value="">All Statuses</option>
                        <option value="active">Active</option>
                        <option value="paused">Paused</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                
                <a href="{{ url_for('dashboard') }}" class="btn btn-small btn-secondary">Clear Filters</a>
            </form>
        </div>
    
        <!-- Overview Summary -->
        <div class="overview-summary">
            <div class="summary-card">
                <div class="summary-icon">üìä</div>
                <div class="summary-info">
                    <span class="summary-value">{{ campaigns|length }}</span>
                    <span class="summary-label">Total Campaigns</span>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon">üí∞</div>
                <div class="summary-info">
                    <span class="summary-value">${{ "%.2f"|format(campaigns|sum(attribute='budget')) }}</span>
                    <span class="summary-label">Total Budget</span>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon">üí∏</div>
                <div class="summary-info">
                    <span class="summary-value">${{ "%.2f"|format(campaigns|sum(attribute='total_spend')) }}</span>
                    <span class="summary-label">Total Spent</span>
                </div>
            </div>
            
            <div class="summary-card">
                <div class="summary-icon">üìà</div>
                <div class="summary-info">
                    <span class="summary-value">{{ "%.1f"|format((campaigns|sum(attribute='roi')) / (campaigns|length)) }}%</span>
                    <span class="summary-label">Average ROI</span>
                </div>
            </div>
        </div>
    
        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-container">
                <h3>Campaign Budget Overview</h3>
                <canvas id="budgetChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>ROI by Campaign</h3>
                <canvas id="roiChart"></canvas>
            </div>
        </div>
    
        <div class="campaigns-grid">
            {% for campaign in campaigns %}
                <div class="campaign-card {% if campaign.budget_used_percent >= 80 %}budget-alert{% endif %}">
                    <div class="campaign-header">
                        <h3>{{ campaign.name }}</h3>
                        <span class="badge badge-{{ campaign.status }}">{{ campaign.status }}</span>
                    </div>
                    
                    <div class="campaign-info">
                        <p><strong>Channel:</strong> {{ campaign.channel }}</p>
                        <p><strong>Budget:</strong> ${{ "%.2f"|format(campaign.budget) }}</p>
                        <p><strong>Spent:</strong> ${{ "%.2f"|format(campaign.total_spend) }}</p>
                        <p><strong>Period:</strong> {{ campaign.start_date }} to {{ campaign.end_date }}</p>
                    </div>
                    
                    <div class="campaign-metrics">
                        <div class="metric">
                            <span class="metric-value">{{ campaign.total_impressions }}</span>
                            <span class="metric-label">Impressions</span>
                        </div>
                        <div class="metric">
                            <span class="metric-value">{{ campaign.total_clicks }}</span>
                            <span class="metric-label">Clicks</span>
                        </div>
                        <div class="metric">
                            <span class="metric-value">{{ campaign.total_conversions }}</span>
                            <span class="metric-label">Conversions</span>
                        </div>
                    </div>
                    
                    <div class="campaign-performance">
                        <div class="roi-display">
                            <span class="roi-label">ROI:</span>
                            <span class="roi-value {% if campaign.roi > 0 %}positive{% else %}negative{% endif %}">
                                {{ "%.2f"|format(campaign.roi) }}%
                            </span>
                        </div>
                        
                        <div class="budget-bar">
                            <div class="budget-bar-fill" style="width: {{ campaign.budget_used_percent }}%"></div>
                        </div>
                        <p class="budget-text">Budget used: {{ "%.1f"|format(campaign.budget_used_percent) }}%</p>
                        
                        {% if campaign.budget_used_percent >= 80 %}
                            <p class="alert-warning">‚ö†Ô∏è Budget alert: You've used over 80% of your budget!</p>
                        {% endif %}
                    </div>
                    
                    <div class="campaign-actions">
                        <a href="{{ url_for('add_metrics', campaign_id=campaign.id) }}" class="btn btn-small">Add Metrics</a>
                        <a href="{{ url_for('edit_campaign', campaign_id=campaign.id) }}" class="btn btn-small">Edit</a>
                        <form method="POST" action="{{ url_for('delete_campaign', campaign_id=campaign.id) }}" style="display: inline;">
                            <button type="submit" class="btn btn-small btn-danger" onclick="return confirm('Are you sure you want to delete this campaign?')">Delete</button>
                        </form>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <h3>No campaigns yet!</h3>
            <p>Create your first marketing campaign to start tracking performance and ROI.</p>
            <a href="{{ url_for('create_campaign') }}" class="btn btn-primary">Create Your First Campaign</a>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Campaign data for charts
const campaignsData = {{ campaigns | tojson | safe }};

// Budget Chart - Shows budget vs spend for each campaign
if (campaignsData && campaignsData.length > 0) {
    const budgetCtx = document.getElementById('budgetChart');
    if (budgetCtx) {
        new Chart(budgetCtx, {
            type: 'bar',
            data: {
                labels: campaignsData.map(c => c.name),
                datasets: [
                    {
                        label: 'Budget',
                        data: campaignsData.map(c => c.budget),
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    },
                    {
                        label: 'Spent',
                        data: campaignsData.map(c => c.total_spend),
                        backgroundColor: 'rgba(255, 107, 107, 0.6)',
                        borderColor: 'rgba(255, 107, 107, 1)',
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value;
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }

    // ROI Chart - Shows ROI percentage for each campaign
    const roiCtx = document.getElementById('roiChart');
    if (roiCtx) {
        new Chart(roiCtx, {
            type: 'bar',
            data: {
                labels: campaignsData.map(c => c.name),
                datasets: [{
                    label: 'ROI (%)',
                    data: campaignsData.map(c => c.roi),
                    backgroundColor: campaignsData.map(c => 
                        c.roi > 0 ? 'rgba(40, 167, 69, 0.6)' : 'rgba(220, 53, 69, 0.6)'
                    ),
                    borderColor: campaignsData.map(c => 
                        c.roi > 0 ? 'rgba(40, 167, 69, 1)' : 'rgba(220, 53, 69, 1)'
                    ),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return 'ROI: ' + context.parsed.y.toFixed(2) + '%';
                            }
                        }
                    }
                }
            }
        });
    }
}
</script>
{% endblock %}
